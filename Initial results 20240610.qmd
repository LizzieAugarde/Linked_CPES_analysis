---
title: "Linked CPES-registry data analysis - sexuality and language status"
author: "Lizzie Augarde"
date: "10/06/2024"
format: html
editor: visual
execute:
  echo: false
  warning: false
---

```{r prep}

#| warning: false
#| echo: false

#before running this document create the resp_data table in "DATA EXTRACTION AND PREP.R" and the rtd_data table in "DATA PREP - ROUTES TO DIAGNOSIS.R"

load("resp_data.RData")
load("rtd_data.RData")
load("stage_data.RData")

library(tidyverse)
library(kableExtra)
library(scales)
library(ggplot2)
```

## Methodology

The England National Cancer Patient Experience Survey

Each year, approximately 50,000 responses to CPES are received.

## Overall composition of respondents

```{r overall_composition}

#| warning: false
#| echo: false

#total responses by year
resps_per_year <- resp_data %>%
  group_by(datayear) %>%
  summarise(count = n())

kable(resps_per_year, 
      col.names = c("Year", "Number of respondents"), 
      format.args = list(big.mark = ","), 
      align = "c",
      caption = "<b>Number of CPES respondents by survey year</b>") %>%
  kable_styling(full_width = F, bootstrap_options = "condensed")


#sexuality composition by year
sexuality_comp <- resp_data %>%
  group_by(datayear, sexuality_bin) %>%
  summarise(count = n()) %>%
  mutate(percent = percent((count/sum(count)), accuracy = 0.1)) %>%
  mutate(sexuality_bin = factor(sexuality_bin, 
                                   levels = c("Heterosexual", "Sexual minority",
                                              "Missing"))) %>%
  mutate(count = comma(count)) %>%
  arrange(datayear, sexuality_bin)


kable(sexuality_comp, 
      col.names = c("Year", "Sexuality", 
                    "Number of respondents", 
                    "Percentage of respondents"),
      align = "clcc",
      caption = "<b>CPES respondents by sexuality and survey year</b>") %>%
  kable_styling(full_width = F, bootstrap_options = "condensed") %>%
  collapse_rows(columns = 1, valign = "top")


#language status composition by year
language_comp <- resp_data %>%
  group_by(datayear, lang_stat) %>%
  summarise(count = n()) %>%
  mutate(percent = percent((count/sum(count)), accuracy = 0.1)) %>%
  mutate(lang_stat = factor(lang_stat, 
                                   levels = c("Native English speaker", 
                                              "Non-native English speaker",
                                              "Missing"))) %>%
  mutate(count = comma(count)) %>%
  arrange(datayear, lang_stat)

kable(language_comp, 
      col.names = c("Year", "Language status", 
                    "Number of respondents", 
                    "Percentage of respondents"),
      align = "clcc",
      caption = "<b>CPES respondents by language status and survey year</b>") %>%
  kable_styling(full_width = F, bootstrap_options = "condensed") %>%
  collapse_rows(columns = 1, valign = "top")



```

## Routes to diagnosis

There is evidence of large variation in survival between those diagnosed via different routes. Exploring routes to diagnosis supports initiatives to promote earlier diagnosis of cancer and thereby improve survival rates and reduce cancer mortality. Differences in cancer outcomes between people with different sexualities and proficiency in English could be related to differences in how groups are likely to be diagnosed.

Analysis of CPES responses linked to routes to diagnosis information from the NDRS cancer registry shows that most respondents are diagnosed via urgent suspected cancer (USC) referrals (previously known as two-week wait/TWW referrals), followed by other GP referral routes, then screening. This reflects the pattern among all cancer patients shown in national routes to diagnosis data in years prior to 2020.

a higher proportion of respondents who describe their sexuality as gay, lesbian, or other, are diagnosed via emergency presentation, compared to the proportion of those describing themselves as heterosexual.

```{r rtd_overall}

#| warning: false
#| echo: false

#total respondents by RTD and year
rtd_composition <- rtd_data %>%
  group_by(datayear, FINAL_ROUTE) %>%
  dplyr::summarise(count = n()) %>%
  mutate(percent = percent((count/sum(count)), accuracy = 0.1)) %>%
  mutate(count = comma(count)) 

kable(rtd_composition, 
      col.names = c("Year", "Route", 
                    "Number of respondents", 
                    "Percentage of respondents"), 
      format.args = list(big.mark = ","), 
      align = "clcc",
      caption = "<b>CPES respondents by route to diagnosis and survey year</b>") %>%
  kable_styling(full_width = F, bootstrap_options = "condensed") %>%
  collapse_rows(columns = 1, valign = "top")

```

```{r rtd_sexuality}

#| warning: false
#| echo: false

#prep 
rtd_sexuality <- rtd_data %>%
  group_by(sexuality_bin, FINAL_ROUTE) %>%
  dplyr::summarise(count = n()) %>%
  group_by(sexuality_bin) %>%
  mutate(percent = (count/sum(count)*100))  %>%
  filter(sexuality_bin != "Missing") %>%
  ungroup() %>%
  mutate(percent_label = as.character(paste0(round(percent, digits = 1), "%")))

#graph
ggplot(rtd_sexuality, aes(x = FINAL_ROUTE, y = percent, fill = sexuality_bin))+
  geom_bar(position = "dodge", stat = "identity") +
  geom_text(position = position_dodge(width = 0.8), 
            aes(y = percent + 0.25, fill = sexuality_bin, label = percent_label, 
                hjust = -0.15), angle = 90, size = 3) +
  ggtitle("Percentage of respondents by route to diagnosis and sexuality, 2017-2019") +
  scale_y_continuous(limits = c(0,60)) +
  labs(x = "Route to diagnosis", 
       y = "Percentage of respondents", 
       fill = "Sexuality") +
  scale_x_discrete(labels = wrap_format(10))
```

```{r rtd_language}

#| warning: false
#| echo: false

#prep
rtd_language <- rtd_data %>%
  group_by(lang_stat, FINAL_ROUTE) %>%
  dplyr::summarise(count = n()) %>%
  group_by(lang_stat) %>%
  mutate(percent = (count/sum(count)*100))  %>%
  filter(lang_stat != "Missing") %>%
  ungroup() %>%
  mutate(percent_label = as.character(paste0(round(percent, digits = 1), "%")))

#graph
ggplot(rtd_language, aes(x = FINAL_ROUTE, y = percent, fill = lang_stat))+
  geom_bar(position = "dodge", stat = "identity") +
  geom_text(position = position_dodge(width = 0.8), 
            aes(y = percent + 0.25, fill = lang_stat, label = percent_label, 
                hjust = -0.15), angle = 90, size = 3) +
  ggtitle("Percentage of respondents by route to diagnosis and language status, 2017-2019") +
  labs(x = "Route to diagnosis", 
       y = "Percentage of respondents", 
       fill = "Language status") +
  scale_y_continuous(limits = c(0,60)) +
  scale_x_discrete(labels = wrap_format(10))

```

```         
::::{.columns}
::: {.column style="font-size: 50%;"}

*Excluding respondents with unknown stage or an unstageable cancer. Excludes those with missing sexuality.*

:::
::::
```

## Stage at diagnosis

Route to diagnosis is closely associated with stage at diagnosis, which is a key predictor of cancer mortality. Early stage at diagnosis is a key aim of the NHS Long-Term plan. As with routes to diagnosis, differences in cancer outcomes between people with different sexualities and proficiency in English could be related to how early different groups are likely to have their cancer diagnosed.

Analysis of CPES responses linked to stage at diagnosis information from the NDRS cancer registry indicates that respondents describing their sexuality as gay, lesbian, or other, are less likely to be diagnosed at a later stage (stage 3 or 4) than heterosexual respondents.

```{r stage_sexuality}

#| warning: false
#| echo: false

#prep
stage_sexuality <- stage_data %>%
  group_by(sexuality_bin, STAGE_2LEVEL) %>%
  dplyr::summarise(count = n()) %>%
  group_by(sexuality_bin) %>%
  mutate(percent = (count/sum(count)*100))  %>%
  filter(sexuality_bin != "Missing", STAGE_2LEVEL != "Not available") %>%
  ungroup() %>%
  mutate(percent_label = as.character(paste0(round(percent, digits = 1), "%"))) 

#graph
ggplot(stage_sexuality, aes(x = STAGE_2LEVEL, y = percent, fill = sexuality_bin))+
  geom_bar(position = "dodge", stat = "identity") +
  geom_text(position = position_dodge(width = 0.8), 
            aes(y = percent + 0.25, fill = sexuality_bin, label = percent_label, 
                hjust = -0.15), angle = 90, size = 3) +
  ggtitle("Percentage of respondents by stage at diagnosis and sexuality, 2017-2022") +
  labs(x = "Stage at diagnosis", 
       y = "Percentage of respondents", 
       fill = "Sexuality") +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_discrete(labels = wrap_format(10))

```

```         
::::{.columns}
::: {.column style="font-size: 50%;"}

*Excluding respondents with unknown stage or an unstageable cancer. Excludes those with missing sexuality.*

:::
::::
```

However, when accounting for confounders, including age at diagnosis and tumour type,.......

Analysis of CPES responses linked to stage at diagnosis information from the NDRS cancer registry indicates that respondents describing themselves as non-native English speakers were more likely to be diagnosed at a later stage than native English speaking respondents.

```{r stage_language}

#| warning: false 
#| echo: false  

#prep 
stage_language <- stage_data %>%   
  group_by(lang_stat, STAGE_2LEVEL) %>%   
  dplyr::summarise(count = n()) %>%   
  group_by(lang_stat) %>%   
  mutate(percent = (count/sum(count)*100))  %>%   
  filter(lang_stat != "Missing", STAGE_2LEVEL != "Not available") %>%   
  ungroup() %>%   
  mutate(percent_label = as.character(paste0(round(percent, digits = 1), "%")))

#graph 
ggplot(stage_language, aes(x = STAGE_2LEVEL, y = percent, fill = lang_stat)) +
  geom_bar(position = "dodge", stat = "identity") +   
  geom_text(position = position_dodge(width = 0.8), 
            aes(y = percent + 0.25, fill = lang_stat, label = percent_label,                  hjust = -0.15), angle = 90, size = 3) +   
  ggtitle("Percentage of respondents by stage at diagnosis and language status, 2017-2022") +   
  labs(x = "Stage at diagnosis",         
       y = "Percentage of respondents",         
       fill = "Language status") +   
  scale_y_continuous(limits = c(0,100)) +  
  scale_x_discrete(labels = wrap_format(10)) 
```

```         
::::{.columns} 
::: {.column style="font-size: 50%;"}  

*Excluding respondents with unknown stage or an unstageable cancer. Excludes those with missing language status.*  

::: 
::::
```

However, when accounting for confounders, including age at diagnosis and tumour type,.......
